---
import TestimonialComponent from './TestimonialComponent.astro';
import { remark } from 'remark';
import html from 'remark-html';

const { pageTag } = Astro.props;

const testimonialsFile = import.meta.glob('/src/content/testimonials.md');

const testimonialsData = await Promise.all(
  Object.values(testimonialsFile).map(async (testimonialFile) => {
    const { frontmatter, default: content } = await testimonialFile();
    const processedContent = await remark().use(html).process(content);
    return { ...frontmatter, content: processedContent.toString() };
  })
);

const testimonials = testimonialsData[0].testimonials.filter(testimonial => testimonial.tag === pageTag);
---

<div class="carousel">
    <div class="carousel-inner">
        {testimonials.map((testimonial, index) => (
            <div class="carousel-item" data-index={index}>
                <TestimonialComponent {...testimonial} />
            </div>
        ))}
    </div>
    <div class="carousel-controls">
        {Array(Math.ceil(testimonials.length / 2)).fill().map((_, index) => (
            <span class="carousel-bullet" data-index={index}></span>
        ))}
    </div>
</div>

<style>
    .carousel {
        position: relative;
        width: 100%;
        max-width: 1200px;
        margin: auto;
        overflow: hidden;
    }

    .carousel-inner {
        display: flex;
        transition: transform 0.5s ease-in-out;
    }

    .carousel-item {
        flex: 0 0 50%; 
        width: 636px; 
        height: 366px; 
        box-sizing: border-box;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        overflow: hidden; 
    }

    .carousel-controls {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }

    .carousel-bullet {
        width: 10px;
        height: 10px;
        background: #ddd;
        border-radius: 50%;
        margin: 5px;
        cursor: pointer;
    }

    .carousel-bullet.active {
        background: #333;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const bullets = document.querySelectorAll('.carousel-bullet');
        const inner = document.querySelector('.carousel-inner');
        const items = document.querySelectorAll('.carousel-item');
        let currentIndex = 0;

        function updateCarousel() {
            const offset = currentIndex * -100 / 2;
            inner.style.transform = `translateX(${offset}%)`;

            bullets.forEach(bullet => bullet.classList.remove('active'));
            bullets[currentIndex].classList.add('active');
        }

        bullets.forEach(bullet => {
            bullet.addEventListener('click', () => {
                currentIndex = parseInt(bullet.getAttribute('data-index'));
                updateCarousel();
            });
        });

        updateCarousel();
    });
</script>
